<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload</title>
    <style>
        progress {
            width: 100%;
            height: 20px;
            background-color: #f3f3f3;
            border: none;
        }

        #uploadProgress::-webkit-progress-bar {
            background-color: #f3f3f3;
        }

        #uploadProgress::-webkit-progress-value {
            background-color: #4CAF50;
        }

        #uploadProgress::-moz-progress-bar {
            background-color: #4CAF50;
        }

        .error {
            background-color: red;
        }
    </style>
</head>

<body>
    <button id="open-modal">modoal open</button>
    <dialog id="upload-modal">
        <h1>Image Upload</h1>
        <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
            <input type="file" id="fileInput" name="images" accept="image/*" multiple>
            <button id="upload-submit" class="browse-btn browse-server-upload" type="submit">Upload</button>
        </form>
        <button id="close-modal">colse modal</button>
        <button id="clear" onclick="clearInput()">clear</button>

        <progress id="uploadProgress" value="0" max="100"></progress>
    </dialog>

    <div class="image-gallery"></div>


    <script>
        // const uploadedImages = [];
        // const openModalBtn = document.getElementById('open-modal'); // open-modal ****
        // const closeModalBtn = document.getElementById('close-modal'); // close-modal ****
        // const modal = document.getElementById('upload-modal'); // upload-modal ****
        // const progressBar = document.getElementById('uploadProgress'); // uploadProgress
        // const uploadForm = document.getElementById('uploadForm'); // uploadForm
        // const imagesInput = document.getElementById('fileInput'); //images
        // const uploadButton = document.querySelector('.browse-server-upload'); // #uploadForm button[type="submit
        // const imageGallery = document.querySelector('.image-gallery');

        const uploadModal_uploadedImages = [];
        const openModalBtn = document.getElementById('open-modal'); // open-modal ****
        const closeModalBtn = document.getElementById('close-modal'); // close-modal ****
        const modal = document.getElementById('upload-modal'); // upload-modal ****
        const uploadModal_progressBar = document.getElementById('uploadProgress'); // uploadProgress
        const uploadModal_uploadForm = document.getElementById('uploadForm'); // uploadForm
        const uploadModal_fileInput = document.getElementById('fileInput'); //images
        const uploadModal_browseServerUpload = document.querySelector('.browse-server-upload'); // #uploadForm button[type="submit
        const imagePreview_imageGallery = document.querySelector('.image-gallery');

        function clearInput() {
            uploadModal_fileInput.value = '';
            uploadModal_fileInput.type = '';
            uploadModal_fileInput.type = 'file';
        }

        function checkUploadButtonState() {
            if (uploadModal_fileInput.files.length > 0) {
                uploadModal_browseServerUpload.disabled = false;
            } else {
                uploadModal_browseServerUpload.disabled = true;
            }
        }

        checkUploadButtonState();
        document.querySelector('#clear').addEventListener('click', checkUploadButtonState);

        openModalBtn.addEventListener('click', () => {
            modal.showModal();
        });

        closeModalBtn.addEventListener('click', () => {
            modal.close();
        });

        async function loadImages(imageNames) {
            try {
                const response = await fetch(`/images?img=${imageNames.join('&img=')}`);
                if (!response.ok) {
                    console.error('Network response was not ok', response.statusText);
                    return;
                }

                const { imagesOut } = await response.json();
                console.log(imagesOut);

                console.log(imagesOut.length)
                if (imagesOut && imagesOut.length > 0) {
                    uploadModal_progressBar.style.visibility = 'visible';
                    uploadModal_progressBar.value = 100;
                    // TODO: need to add css propery visbility hidden 

                    imagesOut.forEach(image => {
                        const imageItem = document.createElement('div');
                        imageItem.classList.add('image-item');
                        const img = document.createElement('img');
                        img.width = "100";
                        img.src = image.srcUrl;
                        img.alt = image.alt;
                        img.classList.add('gallery-img');
                        img.setAttribute('loading', 'lazy');
                        const imagePreviewInfo = document.createElement('div');
                        imagePreviewInfo.classList.add('imagePreview-info-mobile');
                        imagePreviewInfo.textContent = image.alt;
                        imageItem.appendChild(img);
                        imageItem.appendChild(imagePreviewInfo);
                        imagePreview_imageGallery.appendChild(imageItem);
                    });
                    setTimeout(() => {
                        modal.close();
                        setTimeout(() => {
                            uploadModal_progressBar.value = 0;
                            uploadModal_progressBar.style.visibility = 'hidden';
                        }, 1000);
                    }, 1500);
                    imageNames.forEach(name => uploadModal_uploadedImages.push(name));
                    clearInput();
                } else {
                    uploadModal_progressBar.classList.add('error');
                    setTimeout(() => {
                        alert('Failed to upload images. Please try again.');
                        uploadModal_progressBar.classList.remove('error');
                        setTimeout(() => {
                            uploadModal_progressBar.value = 0;
                            uploadModal_progressBar.style.visibility = 'hidden';
                        }, 500);
                    }, 3000);

                    console.log('server recived array is empty!');
                }
            } catch (error) {
                console.error('Fetch error:', error);
            }
        }

        uploadModal_uploadForm.addEventListener('submit', function (event) {
            event.preventDefault();
            if (uploadModal_fileInput.files.length <= 0) {
                console.log('inside condtion 0 images')
                alert('No images selected! Try again by selecting images');
                return;
            }

            const formData = new FormData(this);
            const xhr = new XMLHttpRequest();
            xhr.open('POST', this.action, true);

            xhr.upload.addEventListener('progress', function (event) {
                if (event.lengthComputable) {
                    const progress = (event.loaded / event.total) * 76;
                    uploadModal_progressBar.value = progress;
                }
            });

            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log('Image uploaded successfully');
                    const imageFiles = uploadModal_fileInput.files;
                    const imageNames = Array.from(imageFiles).map(file => file.name);
                    loadImages(imageNames);

                    uploadModal_browseServerUpload.disabled = true;
                } else {
                    console.error('Upload failed:', xhr.statusText);
                }
            };

            xhr.send(formData);
        });

        uploadModal_fileInput.addEventListener('change', function () {
            checkUploadButtonState();
            const selectedFiles = Array.from(this.files);
            const imageFiles = Array.from(this.files);
            const imageNames = imageFiles.map(file => file.name);
            const allImagesMatch = imageNames.every(name => uploadModal_uploadedImages.includes(name));

            if (selectedFiles.length > 5) {
                const remainingFiles = selectedFiles.slice(0, 5);
                const dataTransfer = new DataTransfer();
                remainingFiles.forEach(file => {
                    dataTransfer.items.add(file);
                });
                this.files = dataTransfer.files;
                alert('You can only select up to 5 images.');
            }

            if (!allImagesMatch) {
                uploadModal_browseServerUpload.disabled = false;
            } else {
                uploadModal_browseServerUpload.disabled = true;
                alert('Please select only images that have not been uploaded before.');
            }
        });
    </script>

</body>

</html>